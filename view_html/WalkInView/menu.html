<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Restaurant Menu</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
</head>
<body class="bg-light">
  <div class="container mt-5">
    <h2>Restaurant Menu</h2>

    <!-- Categories Dropdown -->
    <div class="mb-4">
      <label for="categorySelect" class="form-label">Select Category:</label>
      <select id="categorySelect" class="form-select">
        <option value="">-- Choose --</option>
      </select>
    </div>

    <!-- Menu Items Display -->
    <div id="itemsContainer" class="row"></div>

    <hr>

    <!-- Admin Add Item -->
    <h4>Add New Menu Item (Admin)</h4>
    <form id="addItemForm">
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Category ID:</label>
          <input type="number" name="category_id" class="form-control" required>
        </div>
        <div class="col-md-6">
          <label class="form-label">Name:</label>
          <input type="text" name="name" class="form-control" required>
        </div>
        <div class="col-12">
          <label class="form-label">Description:</label>
          <input type="text" name="description" class="form-control">
        </div>
        <div class="col-md-4">
          <label class="form-label">Price:</label>
          <input type="number" name="price" class="form-control" step="0.01" required>
        </div>
        <div class="col-md-4">
          <label class="form-label">Image URL:</label>
          <input type="text" name="image_url" class="form-control">
        </div>
        <div class="col-md-4">
          <label class="form-label">Preparation Time (min):</label>
          <input type="number" name="preparation_time" class="form-control" required>
        </div>
        <div class="col-md-6">
          <label class="form-check-label">
            <input type="checkbox" name="is_available" class="form-check-input" checked> Available
          </label>
        </div>
        <div class="col-md-6">
          <label class="form-check-label">
            <input type="checkbox" name="is_signature" class="form-check-input"> Signature Item
          </label>
        </div>

        <!-- Options -->
        <div class="col-12">
          <label class="form-label">Options:</label>
          <div id="optionsContainer"></div>
          <button type="button" class="btn btn-sm btn-outline-primary" onclick="addOption()">+ Add Option</button>
        </div>

        <div class="col-12 mt-3">
          <button type="submit" class="btn btn-success">Add Menu Item</button>
        </div>
      </div>
    </form>
  </div>

  <script>
    // Load Categories
    function loadCategories() {
  $.get('menu_api.php', function (data) {
    console.log("Categories loaded:", data); // Debug

    data.data.forEach(category => {
      $('#categorySelect').append(
        `<option value="${category.category_id}">${category.name}</option>`
      );
    });
  }).fail(function (xhr, status, error) {
    console.error("Error loading categories:", error);
  });
}

    // Load Items on category change
    $('#categorySelect').on('change', function () {
      const categoryId = $(this).val();
      $('#itemsContainer').empty();

      if (!categoryId) return;

      $.get(`menu_api.php?category_id=${categoryId}`, function (res) {
        const items = res.data;
        if (!items || items.length === 0) {
          $('#itemsContainer').html('<div class="col-12">No items found.</div>');
        } else {
          items.forEach(item => {
            let optionsHTML = '';
            if (item.options.length > 0) {
              optionsHTML = '<ul>';
              item.options.forEach(opt => {
                optionsHTML += `<li>${opt.name} (+RM ${opt.additional_price})</li>`;
              });
              optionsHTML += '</ul>';
            }
            $('#itemsContainer').append(`
              <div class="col-md-4">
                <div class="card mb-3">
                  <div class="card-body">
                    <h5 class="card-title">${item.name}</h5>
                    <p class="card-text">${item.description}</p>
                    <p>Price: RM ${parseFloat(item.price).toFixed(2)}</p>
                    ${optionsHTML}
                  </div>
                </div>
              </div>
            `);
          });
        }
      });
    });

    // Add Option dynamically
    function addOption() {
      $('#optionsContainer').append(`
        <div class="row g-2 mb-2 option-row">
          <div class="col-md-6">
            <input type="text" class="form-control option-name" placeholder="Option Name">
          </div>
          <div class="col-md-4">
            <input type="number" class="form-control option-price" placeholder="Additional Price" step="0.01">
          </div>
          <div class="col-md-2">
            <button type="button" class="btn btn-danger btn-sm" onclick="$(this).closest('.option-row').remove()">Remove</button>
          </div>
        </div>
      `);
    }

    // Submit Add Item Form
    $('#addItemForm').on('submit', function (e) {
      e.preventDefault();

      const formData = new FormData(this);
      const data = Object.fromEntries(formData.entries());
      data.is_available = $('input[name="is_available"]').is(':checked');
      data.is_signature = $('input[name="is_signature"]').is(':checked');
      data.price = parseFloat(data.price);
      data.preparation_time = parseInt(data.preparation_time);

      // Gather options
      data.options = [];
      $('#optionsContainer .option-row').each(function () {
        const name = $(this).find('.option-name').val();
        const price = parseFloat($(this).find('.option-price').val()) || 0;
        if (name) {
          data.options.push({ name, additional_price: price });
        }
      });

      $.ajax({
        url: 'menu_api.php',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(data),
        success: function (res) {
          alert('Menu item added successfully!');
          $('#addItemForm')[0].reset();
          $('#optionsContainer').empty();
        },
        error: function (xhr) {
          alert('Failed to add item: ' + xhr.responseText);
        }
      });
    });

    $(document).ready(function () {
      loadCategories();
    });
  </script>
</body>
</html>
